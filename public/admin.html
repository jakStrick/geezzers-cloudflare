<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>Geezzers Admin - Comment Moderation</title>
		<style>
			body {
				font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
					sans-serif;
				padding: 20px;
				background: #f5f5f5;
				margin: 0;
			}
			.header {
				background: #2c5aa0;
				color: white;
				padding: 20px;
				margin: -20px -20px 20px -20px;
				border-radius: 0 0 8px 8px;
			}
			.header h1 {
				margin: 0;
				display: flex;
				align-items: center;
				gap: 10px;
			}
			.stats {
				display: flex;
				gap: 20px;
				margin: 20px 0;
			}
			.stat-card {
				background: white;
				padding: 15px;
				border-radius: 8px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
				text-align: center;
				min-width: 120px;
			}
			.stat-number {
				font-size: 2em;
				font-weight: bold;
				color: #2c5aa0;
			}
			.filters {
				background: white;
				padding: 15px;
				border-radius: 8px;
				margin-bottom: 20px;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
			}
			.filter-btn {
				background: #f8f9fa;
				border: 1px solid #ddd;
				padding: 8px 16px;
				margin-right: 10px;
				border-radius: 4px;
				cursor: pointer;
				transition: all 0.2s;
			}
			.filter-btn.active {
				background: #2c5aa0;
				color: white;
				border-color: #2c5aa0;
			}
			.comment {
				border: 1px solid #ddd;
				padding: 15px;
				margin: 10px 0;
				border-radius: 8px;
				background: white;
				box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
			}
			.comment-header {
				display: flex;
				justify-content: between;
				align-items: center;
				margin-bottom: 10px;
				flex-wrap: wrap;
				gap: 10px;
			}
			.comment-author {
				font-weight: bold;
				color: #2c5aa0;
			}
			.comment-post {
				color: #666;
				font-size: 0.9em;
			}
			.comment-date {
				color: #888;
				font-size: 0.85em;
				margin-left: auto;
			}
			.comment-content {
				margin: 10px 0;
				line-height: 1.5;
			}
			.comment-actions {
				display: flex;
				gap: 10px;
				align-items: center;
				flex-wrap: wrap;
			}
			.status-badge {
				padding: 4px 12px;
				border-radius: 20px;
				font-size: 0.8em;
				font-weight: bold;
				text-transform: uppercase;
			}
			.status-pending {
				background: #fff3cd;
				color: #856404;
			}
			.status-approved {
				background: #d4edda;
				color: #155724;
			}
			.status-rejected {
				background: #f8d7da;
				color: #721c24;
			}
			button {
				padding: 8px 16px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-size: 0.9em;
				transition: all 0.2s;
			}
			.btn-approve {
				background: #28a745;
				color: white;
			}
			.btn-approve:hover {
				background: #218838;
			}
			.btn-reject {
				background: #dc3545;
				color: white;
			}
			.btn-reject:hover {
				background: #c82333;
			}
			.btn-delete {
				background: #6c757d;
				color: white;
			}
			.btn-delete:hover {
				background: #5a6268;
			}
			.loading {
				text-align: center;
				padding: 40px;
				color: #666;
			}
		</style>
	</head>
	<body>
		<!-- Login Modal -->
		<div
			id="loginModal"
			style="
				position: fixed;
				top: 0;
				left: 0;
				width: 100%;
				height: 100%;
				background: rgba(0, 0, 0, 0.8);
				display: flex;
				align-items: center;
				justify-content: center;
				z-index: 1000;
			">
			<div
				style="
					background: white;
					padding: 30px;
					border-radius: 8px;
					width: 300px;
					box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
				">
				<h2 style="margin-top: 0; text-align: center; color: #2c5aa0">
					üîí Admin Login
				</h2>
				<div style="margin-bottom: 15px">
					<label
						style="display: block; margin-bottom: 5px; font-weight: bold"
						>Username:</label
					>
					<input
						type="text"
						id="username"
						style="
							width: 100%;
							padding: 8px;
							border: 1px solid #ddd;
							border-radius: 4px;
							box-sizing: border-box;
						" />
				</div>
				<div style="margin-bottom: 20px">
					<label
						style="display: block; margin-bottom: 5px; font-weight: bold"
						>Password:</label
					>
					<input
						type="password"
						id="password"
						style="
							width: 100%;
							padding: 8px;
							border: 1px solid #ddd;
							border-radius: 4px;
							box-sizing: border-box;
						" />
				</div>
				<button
					onclick="login()"
					style="
						width: 100%;
						padding: 10px;
						background: #2c5aa0;
						color: white;
						border: none;
						border-radius: 4px;
						font-size: 16px;
						cursor: pointer;
					">
					Login
				</button>
				<div
					id="loginError"
					style="
						color: #dc3545;
						margin-top: 10px;
						text-align: center;
						display: none;
					"></div>
			</div>
		</div>

		<div id="adminContent" style="display: none">
			<div class="header">
				<h1>üõ°Ô∏è Geezzers Admin - Comment Moderation</h1>
				<button
					onclick="logout()"
					style="
						position: absolute;
						top: 20px;
						right: 20px;
						background: rgba(255, 255, 255, 0.2);
						color: white;
						border: 1px solid rgba(255, 255, 255, 0.3);
						padding: 5px 10px;
						border-radius: 4px;
						cursor: pointer;
					">
					Logout
				</button>
			</div>

			<div class="stats" id="stats">
				<div class="stat-card">
					<div class="stat-number" id="total-comments">-</div>
					<div>Total Comments</div>
				</div>
				<div class="stat-card">
					<div class="stat-number" id="pending-count">-</div>
					<div>Pending</div>
				</div>
				<div class="stat-card">
					<div class="stat-number" id="approved-count">-</div>
					<div>Approved</div>
				</div>
				<div class="stat-card">
					<div class="stat-number" id="rejected-count">-</div>
					<div>Rejected</div>
				</div>
			</div>

			<div class="filters">
				<button class="filter-btn active" onclick="filterComments('all')">
					All Comments
				</button>
				<button class="filter-btn" onclick="filterComments('pending')">
					Pending Review
				</button>
				<button class="filter-btn" onclick="filterComments('approved')">
					Approved
				</button>
				<button class="filter-btn" onclick="filterComments('rejected')">
					Rejected
				</button>
			</div>

			<div id="comments">
				<div class="loading">Loading comments...</div>
			</div>
		</div>

		<script>
			let allComments = [];
			let currentFilter = "all";
			let authCredentials = null;

			// Authentication functions
			function login() {
				console.log("Login function called");
				const username = document.getElementById("username").value;
				const password = document.getElementById("password").value;

				console.log(
					"Username:",
					username,
					"Password length:",
					password.length
				);

				if (!username || !password) {
					showError("Please enter both username and password");
					return;
				}

				// Clear any existing errors
				hideError();

				// Create base64 encoded credentials
				authCredentials = btoa(username + ":" + password);
				console.log("Generated credentials, calling testAuth(true)");

				// Test authentication by trying to load stats
				testAuth(true); // Explicitly pass true to show errors
			}
			function logout() {
				authCredentials = null;
				localStorage.removeItem("adminAuth");
				showLogin();
			}

			function showLogin() {
				document.getElementById("loginModal").style.display = "flex";
				document.getElementById("adminContent").style.display = "none";
				document.getElementById("username").value = "";
				document.getElementById("password").value = "";
				hideError();
			}

			function showAdmin() {
				document.getElementById("loginModal").style.display = "none";
				document.getElementById("adminContent").style.display = "block";
				// Save auth to localStorage (optional - for convenience)
				localStorage.setItem("adminAuth", authCredentials);
				loadComments();
			}

			function showError(message) {
				console.log("showError called with message:", message);
				const errorDiv = document.getElementById("loginError");
				if (errorDiv) {
					errorDiv.textContent = message;
					errorDiv.style.display = "block";
					console.log("Error displayed:", errorDiv.textContent);
				} else {
					console.error("loginError element not found!");
				}
			}

			function hideError() {
				document.getElementById("loginError").style.display = "none";
			}

			async function testAuth(showErrors = true) {
				console.log("testAuth called, showErrors:", showErrors);
				try {
					const response = await fetch("/api/admin/stats", {
						headers: {
							Authorization: "Basic " + authCredentials,
						},
					});

					console.log("Response status:", response.status);
					console.log("Response ok:", response.ok);

					if (response.ok) {
						console.log("Auth successful, showing admin");
						showAdmin();
					} else if (response.status === 401) {
						console.log("Auth failed (401), showErrors:", showErrors);
						if (showErrors) {
							console.log("Showing error message");
							showError("Invalid username or password");
						}
						// Clear invalid saved credentials
						localStorage.removeItem("adminAuth");
						authCredentials = null;
						showLogin();
					} else {
						console.log("Auth failed (other), showErrors:", showErrors);
						if (showErrors) {
							console.log("Showing generic error message");
							showError("Authentication failed. Please try again.");
						}
						showLogin();
					}
				} catch (error) {
					console.error("Auth test failed:", error);
					if (showErrors) {
						console.log("Showing connection error");
						showError("Connection error. Please try again.");
					}
					showLogin();
				}
			} // Helper function to make authenticated requests
			function makeAuthRequest(url, options = {}) {
				if (!authCredentials) {
					showLogin();
					return Promise.reject(new Error("Not authenticated"));
				}

				const authHeaders = {
					Authorization: "Basic " + authCredentials,
					...options.headers,
				};

				return fetch(url, {
					...options,
					headers: authHeaders,
				});
			}

			async function loadStats() {
				try {
					const response = await makeAuthRequest("/api/admin/stats");
					if (!response.ok) {
						if (response.status === 401) {
							showLogin();
							return;
						}
						throw new Error("Failed to load stats");
					}
					const stats = await response.json();

					document.getElementById("total-comments").textContent =
						stats.total;

					// Initialize counts
					let pending = 0,
						approved = 0,
						rejected = 0;

					stats.statusCounts.forEach((item) => {
						if (item.status === "pending") pending = item.count;
						if (item.status === "approved") approved = item.count;
						if (item.status === "rejected") rejected = item.count;
					});

					document.getElementById("pending-count").textContent = pending;
					document.getElementById("approved-count").textContent = approved;
					document.getElementById("rejected-count").textContent = rejected;
				} catch (error) {
					console.error("Error loading stats:", error);
				}
			}

			async function loadComments() {
				try {
					const response = await makeAuthRequest("/api/admin/comments");
					if (!response.ok) {
						if (response.status === 401) {
							showLogin();
							return;
						}
						throw new Error("Failed to load comments");
					}

					const data = await response.json();
					allComments = data.comments || data; // Handle different response formats
					displayComments();
					loadStats();
				} catch (error) {
					console.error("Error loading comments:", error);
					document.getElementById("comments").innerHTML =
						'<div class="loading">‚ùå Error loading comments. Check console for details.</div>';
				}
			}

			function displayComments() {
				const filteredComments =
					currentFilter === "all"
						? allComments
						: allComments.filter((c) => c.status === currentFilter);

				if (filteredComments.length === 0) {
					document.getElementById(
						"comments"
					).innerHTML = `<div class="loading">No ${
						currentFilter === "all" ? "" : currentFilter + " "
					}comments found.</div>`;
					return;
				}

				document.getElementById("comments").innerHTML = filteredComments
					.map(
						(c) => `
						<div class="comment" data-status="${c.status}">
							<div class="comment-header">
								<div>
									<span class="comment-author">${escapeHtml(c.author_name)}</span>
									<span class="comment-post">on "${c.post_title || "Unknown Post"}"</span>
								</div>
								<div class="comment-date">${formatDate(c.created_at)}</div>
							</div>
							<div class="comment-content">${escapeHtml(c.content)}</div>
							<div class="comment-actions">
								<span class="status-badge status-${c.status}">${c.status}</span>
								${
									c.status !== "approved"
										? `<button class="btn-approve" onclick="updateComment(${c.id}, 'approved')">‚úì Approve</button>`
										: ""
								}
								${
									c.status !== "rejected"
										? `<button class="btn-reject" onclick="updateComment(${c.id}, 'rejected')">‚úó Reject</button>`
										: ""
								}
								<button class="btn-delete" onclick="deleteComment(${c.id})">üóëÔ∏è Delete</button>
							</div>
						</div>
					`
					)
					.join("");
			}

			function filterComments(status) {
				currentFilter = status;

				// Update active filter button
				document
					.querySelectorAll(".filter-btn")
					.forEach((btn) => btn.classList.remove("active"));
				event.target.classList.add("active");

				displayComments();
			}

			async function updateComment(id, status) {
				try {
					const response = await makeAuthRequest(
						`/api/admin/comments/${id}`,
						{
							method: "PATCH",
							headers: { "Content-Type": "application/json" },
							body: JSON.stringify({ status }),
						}
					);

					if (response.ok) {
						// Update local data
						const comment = allComments.find((c) => c.id === id);
						if (comment) comment.status = status;

						displayComments();
						loadStats();
					} else if (response.status === 401) {
						showLogin();
					} else {
						alert("Error updating comment status");
					}
				} catch (error) {
					console.error("Error updating comment:", error);
					alert("Error updating comment");
				}
			}

			async function deleteComment(id) {
				if (
					!confirm(
						"Are you sure you want to delete this comment? This action cannot be undone."
					)
				) {
					return;
				}

				try {
					const response = await makeAuthRequest(
						`/api/admin/comments/${id}`,
						{
							method: "DELETE",
						}
					);

					if (response.ok) {
						// Remove from local data
						allComments = allComments.filter((c) => c.id !== id);
						displayComments();
						loadStats();
					} else if (response.status === 401) {
						showLogin();
					} else {
						alert("Error deleting comment");
					}
				} catch (error) {
					console.error("Error deleting comment:", error);
					alert("Error deleting comment");
				}
			}

			function escapeHtml(text) {
				const div = document.createElement("div");
				div.textContent = text;
				return div.innerHTML;
			}

			function formatDate(dateString) {
				const date = new Date(dateString);
				return date.toLocaleDateString() + " " + date.toLocaleTimeString();
			}

			// Initialize page
			window.addEventListener("DOMContentLoaded", function () {
				// Check if we have saved auth
				const savedAuth = localStorage.getItem("adminAuth");
				if (savedAuth) {
					authCredentials = savedAuth;
					testAuth(false); // Verify saved credentials silently
				} else {
					showLogin();
				}

				// Add logout button functionality
				const logoutBtn = document.querySelector(
					'button[onclick*="Logout"]'
				);
				if (logoutBtn) {
					logoutBtn.onclick = logout;
				}

				// Add enter key support for login
				document
					.getElementById("password")
					.addEventListener("keypress", function (e) {
						if (e.key === "Enter") {
							login();
						}
					});
			});

			// Auto-refresh every 30 seconds (only when authenticated)
			setInterval(() => {
				if (
					authCredentials &&
					document.getElementById("adminContent").style.display !== "none"
				) {
					loadComments();
				}
			}, 30000);
		</script>
	</body>
</html>
